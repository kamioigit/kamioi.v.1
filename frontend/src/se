import axios from "axios";

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || "http://127.0.0.1:5000";

export const ROLES = {
  USER: "user",
  ADMIN: "admin",
};

const TOKEN_KEYS = {
  [ROLES.USER]: "kamioi_user_token",
  [ROLES.ADMIN]: "kamioi_admin_token",
};

export function setToken(role, token) { localStorage.setItem(TOKEN_KEYS[role], token); }
export function getToken(role) { return localStorage.getItem(TOKEN_KEYS[role]) || null; }
export function clearToken(role) { localStorage.removeItem(TOKEN_KEYS[role]); }

const client = axios.create({ baseURL: API_BASE_URL, timeout: 15000 });

client.interceptors.request.use((config) => {
  const role = config.meta?.role;
  const token = role ? getToken(role) : null;
  if (token) config.headers.Authorization = `Bearer ${token}`;
  config.headers["Content-Type"] = "application/json";
  return config;
});
client.interceptors.response.use((res) => res, (err) => Promise.reject(err));

export const AuthAPI = {
  loginUser: (email, password) =>
    client.post("/api/user/auth/login", { email, password }, { meta: { role: ROLES.USER } }),
  loginAdmin: (email, password) =>
    client.post("/api/admin/auth/login", { email, password }, { meta: { role: ROLES.ADMIN } }),
  meUser: () => client.get("/api/user/auth/me", { meta: { role: ROLES.USER } }),
  meAdmin: () => client.get("/api/admin/auth/me", { meta: { role: ROLES.ADMIN } }),
};

// Named buckets still available
export const UserAPI = {
  transactions: () => client.get("/api/user/transactions", { meta: { role: ROLES.USER } }),
};

export const AdminAPI = {
  users: () => client.get("/api/admin/users", { meta: { role: ROLES.ADMIN } }),
  performanceStorage: () => client.get("/api/admin/performance/storage", { meta: { role: ROLES.ADMIN } }),
};

// --- Compatibility helpers so legacy code like `apiService.getTransactions()` works ---
export const getTransactions = () => UserAPI.transactions();

/** Safe admin /auth/me; returns {data:null} if no admin token to avoid 422 spam */
export const getAdminMeSafe = () => {
  const t = getToken(ROLES.ADMIN);
  return t ? AuthAPI.meAdmin() : Promise.resolve({ data: null });
};

// Make default export be the axios client PLUS helpers, so both styles work:
// - apiService.get(...) // axios
// - apiService.getTransactions() // our helper
const apiService = Object.assign(client, {
  getTransactions,
  getAdminMeSafe,
  setToken,
  getToken,
  clearToken,
  ROLES,
});

export default apiService;
